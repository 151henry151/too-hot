<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Too Hot Climate Campaign</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-cog mr-3 text-blue-600"></i>
                    Admin Dashboard
                </h1>
                <p class="text-gray-600">Manage push notifications and view system status</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-bell text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Push Subscribers</h3>
                            <p class="text-2xl font-bold text-blue-600" id="subscriber-count">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-envelope text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Email Subscribers</h3>
                            <p class="text-2xl font-bold text-green-600" id="email-count">{{ email_subs|length }}</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-thermometer-half text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Temperature Alerts</h3>
                            <p class="text-2xl font-bold text-purple-600" id="alert-count">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Push Notification Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-bell mr-2 text-blue-600"></i>
                    Push Notifications
                </h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Send Test Notification</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" id="notification-title" value="Climate Alert" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Body</label>
                            <input type="text" id="notification-body" value="Test notification from Too Hot campaign" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <button id="send-notification" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Send Notification
                    </button>
                </div>

                <div id="notification-result" class="hidden mt-4 p-4 rounded-md"></div>
            </div>

            <!-- Subscribers List -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-users mr-2 text-green-600"></i>
                    Push Subscribers
                </h2>
                
                <div id="subscribers-list" class="space-y-2">
                    <p class="text-gray-500">No subscribers yet. Visit the main site and enable push notifications.</p>
                </div>
            </div>

            <!-- Email Subscribers Table -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-envelope mr-2 text-green-600"></i>
                    Email Subscribers
                </h2>
                {% if email_subs and email_subs|length > 0 %}
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded shadow">
                        <thead>
                            <tr>
                                <th class="py-2 px-4">Email</th>
                                <th class="py-2 px-4">Location</th>
                                <th class="py-2 px-4">Subscribed At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in email_subs %}
                            <tr>
                                <td class="py-2 px-4">{{ sub.email }}</td>
                                <td class="py-2 px-4">{{ sub.location }}</td>
                                <td class="py-2 px-4">{{ sub.subscribed_at }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500">No email subscribers yet.</p>
                {% endif %}
            </div>

            <!-- System Status -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-server mr-2 text-purple-600"></i>
                    System Status
                </h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Services</h3>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                <span class="text-sm">Flask App</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                <span class="text-sm">Push Notifications</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                <span class="text-sm">Service Worker</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                <span class="text-sm">VAPID Keys</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Quick Actions</h3>
                        <div class="space-y-2">
                            <button onclick="window.open('http://127.0.0.1:5000', '_blank')" 
                                    class="w-full text-left px-3 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors">
                                <i class="fas fa-external-link-alt mr-2"></i>
                                View Main Site
                            </button>
                            <button onclick="refreshData()" 
                                    class="w-full text-left px-3 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Refresh Data
                            </button>
                            <button onclick="testNotification()" 
                                    class="w-full text-left px-3 py-2 bg-purple-100 text-purple-700 rounded-md hover:bg-purple-200 transition-colors">
                                <i class="fas fa-bell mr-2"></i>
                                Test Notification
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscribers();
            loadStats();
        });

        // Send notification
        document.getElementById('send-notification').addEventListener('click', function() {
            const title = document.getElementById('notification-title').value;
            const body = document.getElementById('notification-body').value;
            
            if (!title || !body) {
                alert('Please fill in both title and body');
                return;
            }
            
            sendNotification(title, body);
        });

        function sendNotification(title, body) {
            const button = document.getElementById('send-notification');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
            
            fetch('/api/send-push-notification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    body: body,
                    url: '/'
                })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('notification-result');
                resultDiv.className = data.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                resultDiv.innerHTML = `
                    <strong>${data.success ? '✅ Success' : '❌ Error'}:</strong> ${data.message}
                    ${data.successful_sends ? `<br>✅ Successful sends: ${data.successful_sends}` : ''}
                    ${data.failed_sends ? `<br>❌ Failed sends: ${data.failed_sends}` : ''}
                    ${data.total_subscribers ? `<br>📊 Total subscribers: ${data.total_subscribers}` : ''}
                `;
                resultDiv.classList.remove('hidden');
                
                // Refresh data
                setTimeout(() => {
                    loadSubscribers();
                    loadStats();
                }, 1000);
            })
            .catch(error => {
                const resultDiv = document.getElementById('notification-result');
                resultDiv.className = 'bg-red-100 text-red-700';
                resultDiv.innerHTML = `<strong>❌ Error:</strong> ${error.message}`;
                resultDiv.classList.remove('hidden');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
        }

        function loadSubscribers() {
            fetch('/api/push-subscribers')
            .then(response => response.json())
            .then(data => {
                const listDiv = document.getElementById('subscribers-list');
                if (data.subscribers && data.subscribers.length > 0) {
                    listDiv.innerHTML = data.subscribers.map(sub => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                            <div>
                                <div class="font-medium">${sub.push_token ? sub.push_token.substring(0, 30) + '...' : 'Unknown'}</div>
                                <div class="text-sm text-gray-500">
                                    Platform: ${sub.platform || 'N/A'} | Device: ${sub.device_type || 'N/A'}<br>
                                    Registered: ${sub.registered_at ? new Date(sub.registered_at).toLocaleString() : 'Unknown'}
                                </div>
                            </div>
                            <div class="text-sm text-green-600">Active</div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p class="text-gray-500">No subscribers yet. Visit the main site and enable push notifications.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading subscribers:', error);
            });
        }

        function loadStats() {
            // Update subscriber count
            fetch('/api/push-subscribers')
            .then(response => response.json())
            .then(data => {
                document.getElementById('subscriber-count').textContent = data.subscribers ? data.subscribers.length : 0;
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
        }

        function refreshData() {
            loadSubscribers();
            loadStats();
        }

        function testNotification() {
            document.getElementById('notification-title').value = 'Test Climate Alert';
            document.getElementById('notification-body').value = 'This is a test notification from the Too Hot climate awareness campaign!';
            sendNotification('Test Climate Alert', 'This is a test notification from the Too Hot climate awareness campaign!');
        }
    </script>
</body>
</html> 