<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Too Hot Climate Campaign</title>
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        .notification-info { background-color: #3b82f6; }
        .notification-success { background-color: #10b981; }
        .notification-warning { background-color: #f59e0b; }
        .notification-error { background-color: #ef4444; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-cog mr-3 text-blue-600"></i>
                    Admin Dashboard
                </h1>
                <p class="text-gray-600">Manage your climate awareness campaign</p>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-8">
                <div class="flex flex-wrap gap-2">
                    <button class="tab-button active px-4 py-2 rounded-md font-medium transition-colors" data-tab="overview">
                        <i class="fas fa-chart-pie mr-2"></i>Overview
                    </button>
                    <button class="tab-button px-4 py-2 rounded-md font-medium transition-colors" data-tab="system">
                        <i class="fas fa-cogs mr-2"></i>System
                    </button>
                    <button class="tab-button px-4 py-2 rounded-md font-medium transition-colors" data-tab="notifications">
                        <i class="fas fa-bell mr-2"></i>Notifications
                    </button>
                    <button class="tab-button px-4 py-2 rounded-md font-medium transition-colors" data-tab="monitoring">
                        <i class="fas fa-chart-line mr-2"></i>Monitoring
                    </button>
                    <button class="tab-button px-4 py-2 rounded-md font-medium transition-colors" data-tab="development">
                        <i class="fas fa-code mr-2"></i>Development
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                {% include 'admin_components/overview.html' %}
                {% include 'admin_components/system.html' %}
                {% include 'admin_components/notifications.html' %}
                {% include 'admin_components/monitoring.html' %}
                {% include 'admin_components/development.html' %}
            </div>
        </div>
    </div>

    <script>
        // Global notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Loading state management
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('loading');
                element.disabled = true;
            }
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('loading');
                element.disabled = false;
            }
        }

        // Tab management
        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to selected tab button
            const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        }

        // Unified API call function
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API call failed:', error);
                showNotification(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Data loading functions
        async function loadStats() {
            try {
                const data = await apiCall('/api/push-subscribers');
                const subscriberCount = data.subscribers ? data.subscribers.length : 0;
                document.getElementById('subscriber-count').textContent = subscriberCount;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadSchedulerHealth() {
            try {
                const data = await apiCall('/api/scheduler/health');
                
                const statusElement = document.getElementById('scheduler-status');
                const lastCheckElement = document.getElementById('scheduler-last-check');
                const nextCheckElement = document.getElementById('scheduler-next-check');
                const indicatorElement = document.getElementById('scheduler-indicator');
                
                if (data.status === 'healthy') {
                    statusElement.textContent = 'Healthy';
                    statusElement.className = 'text-sm font-semibold text-green-600';
                    indicatorElement.className = 'w-3 h-3 bg-green-500 rounded-full mr-3';
                } else {
                    statusElement.textContent = 'Unhealthy';
                    statusElement.className = 'text-sm font-semibold text-red-600';
                    indicatorElement.className = 'w-3 h-3 bg-red-500 rounded-full mr-3';
                }
                
                if (data.last_check) {
                    const lastCheck = new Date(data.last_check);
                    const now = new Date();
                    const diffMs = now - lastCheck;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    let lastCheckText = '';
                    if (diffMins < 1) {
                        lastCheckText = 'Last check: Just now';
                    } else if (diffMins < 60) {
                        lastCheckText = `Last check: ${diffMins} minutes ago`;
                    } else {
                        const diffHours = Math.floor(diffMins / 60);
                        lastCheckText = `Last check: ${diffHours} hours ago`;
                    }
                    
                    lastCheckElement.textContent = lastCheckText;
                    nextCheckElement.textContent = data.next_check_info || 'Next check: Soon';
                }
            } catch (error) {
                console.error('Failed to load scheduler health:', error);
            }
        }

        async function loadLogs() {
            try {
                const logType = document.getElementById('log-type').value;
                const data = await apiCall(`/api/logs?type=${logType}`);
                
                let logsHtml = '';
                if (data.logs && data.logs.length > 0) {
                    logsHtml = data.logs.map(log => {
                        const timestamp = new Date(log.timestamp).toLocaleString();
                        return `<div class="border-b py-2 px-1">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">${timestamp}</span>
                                <span class="text-xs font-medium">${log.status || log.source || 'Unknown'}</span>
                            </div>
                            <div class="text-sm">${log.message || log.title || 'No message'}</div>
                        </div>`;
                    }).join('');
                } else {
                    logsHtml = '<div class="text-gray-500 text-center py-4">No logs found</div>';
                }
                
                document.getElementById('logs-list').innerHTML = logsHtml;
            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('logs-list').innerHTML = '<div class="text-red-500 text-center py-4">Failed to load logs</div>';
            }
        }

        async function loadPushSubscribers() {
            try {
                const data = await apiCall('/api/push-subscribers');
                
                if (data.subscribers && data.subscribers.length > 0) {
                    const html = data.subscribers.map(sub => `
                        <div class="flex items-center justify-between bg-white p-2 rounded border mb-2">
                            <div class="flex-1">
                                <div class="text-sm font-medium">${sub.platform || 'Unknown'} - ${sub.device_type || 'Unknown'}</div>
                                <div class="text-xs text-gray-500">${sub.registered_at ? new Date(sub.registered_at).toLocaleString() : 'Unknown'}</div>
                            </div>
                            <button onclick="deletePushSubscriber(${sub.id})" 
                                    class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                    
                    document.getElementById('push-subscribers-list').innerHTML = html;
                } else {
                    document.getElementById('push-subscribers-list').innerHTML = '<p class="text-gray-500 text-center">No push subscribers yet.</p>';
                }
            } catch (error) {
                console.error('Failed to load push subscribers:', error);
                document.getElementById('push-subscribers-list').innerHTML = '<p class="text-red-500 text-center">Failed to load subscribers</p>';
            }
        }

        // Event handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Show overview tab by default
            switchTab('overview');

            // Load initial data
            loadStats();
            loadSchedulerHealth();
            loadLogs();
            loadPushSubscribers();

            // Set up auto-refresh for scheduler health
            setInterval(loadSchedulerHealth, 30000);

            // Set up auto-refresh for logs if enabled
            document.getElementById('auto-refresh-logs').addEventListener('change', function() {
                if (this.checked) {
                    window.logsInterval = setInterval(loadLogs, 30000);
                } else {
                    if (window.logsInterval) {
                        clearInterval(window.logsInterval);
                    }
                }
            });

            // System management event handlers
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('pause-scheduler').addEventListener('click', () => controlScheduler('pause'));
            document.getElementById('resume-scheduler').addEventListener('click', () => controlScheduler('resume'));
            document.getElementById('test-scheduler').addEventListener('click', testScheduler);

            // Notification testing event handlers
            document.getElementById('test-email-btn').addEventListener('click', sendTestEmail);
            document.getElementById('test-push-btn').addEventListener('click', sendTestPush);
            document.getElementById('test-alert-btn').addEventListener('click', sendTestAlert);

            // Monitoring event handlers
            document.getElementById('refresh-logs').addEventListener('click', loadLogs);

            // Development event handlers
            document.getElementById('check-updates').addEventListener('click', checkForUpdates);
            document.getElementById('publish-update').addEventListener('click', publishUpdate);
            document.getElementById('rollback-update').addEventListener('click', rollbackUpdate);
        });

        // Settings management
        async function saveSettings() {
            const threshold = document.querySelector('input[name="threshold"]:checked').value;
            const frequency = document.querySelector('input[name="frequency"]:checked').value;
            
            showLoading('save-settings');
            
            try {
                const data = await apiCall('/api/settings', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        threshold: parseInt(threshold), 
                        frequency 
                    })
                });
                
                showNotification('Settings saved successfully', 'success');
                document.getElementById('settings-result').className = 'mt-4 p-4 rounded-md bg-green-100 text-green-800';
                document.getElementById('settings-result').textContent = data.message || 'Settings saved';
                document.getElementById('settings-result').classList.remove('hidden');
                
                setTimeout(() => {
                    document.getElementById('settings-result').classList.add('hidden');
                }, 3000);
            } catch (error) {
                showNotification('Failed to save settings', 'error');
            } finally {
                hideLoading('save-settings');
            }
        }

        // Scheduler controls
        async function controlScheduler(action) {
            const buttonId = action === 'pause' ? 'pause-scheduler' : 'resume-scheduler';
            showLoading(buttonId);
            
            try {
                const frequency = document.querySelector('input[name="frequency"]:checked').value;
                const jobName = frequency === 'hourly' ? 'hourly-temperature-check' : 'daily-temperature-check';
                
                const data = await apiCall('/api/scheduler/job-control', {
                    method: 'POST',
                    body: JSON.stringify({
                        job_name: jobName,
                        action: action
                    })
                });
                
                showNotification(`Scheduler ${action}d successfully`, 'success');
                loadSchedulerHealth();
            } catch (error) {
                showNotification(`Failed to ${action} scheduler`, 'error');
            } finally {
                hideLoading(buttonId);
            }
        }

        async function testScheduler() {
            showLoading('test-scheduler');
            
            try {
                const data = await apiCall('/api/scheduler/check-temperatures');
                showNotification('Scheduler test completed successfully', 'success');
                loadLogs();
            } catch (error) {
                showNotification('Scheduler test failed', 'error');
            } finally {
                hideLoading('test-scheduler');
            }
        }

        // Notification testing
        async function sendTestEmail() {
            showLoading('test-email-btn');
            
            try {
                const data = await apiCall('/admin/send-test-email', {
                    method: 'POST',
                    body: JSON.stringify({ send_to_all: true })
                });
                
                showNotification('Test email sent successfully', 'success');
            } catch (error) {
                showNotification('Failed to send test email', 'error');
            } finally {
                hideLoading('test-email-btn');
            }
        }

        async function sendTestPush() {
            const title = document.getElementById('test-push-title').value;
            const body = document.getElementById('test-push-body').value;
            
            showLoading('test-push-btn');
            
            try {
                const data = await apiCall('/api/send-push-notification', {
                    method: 'POST',
                    body: JSON.stringify({ title, body, url: '/' })
                });
                
                showNotification('Test push notification sent successfully', 'success');
                loadLogs();
            } catch (error) {
                showNotification('Failed to send test push notification', 'error');
            } finally {
                hideLoading('test-push-btn');
            }
        }

        async function sendTestAlert() {
            const location = document.getElementById('test-alert-location').value;
            const useReal = document.getElementById('test-alert-real-data').checked;
            const currentTemp = document.getElementById('test-alert-current').value;
            const avgTemp = document.getElementById('test-alert-avg').value;
            
            showLoading('test-alert-btn');
            
            try {
                const data = await apiCall('/api/test-temperature-alert', {
                    method: 'POST',
                    body: JSON.stringify({
                        location,
                        use_real_data: useReal,
                        current_temp: currentTemp ? parseFloat(currentTemp) : undefined,
                        avg_temp: avgTemp ? parseFloat(avgTemp) : undefined
                    })
                });
                
                showNotification('Test alert sent successfully', 'success');
                loadLogs();
            } catch (error) {
                showNotification('Failed to send test alert', 'error');
            } finally {
                hideLoading('test-alert-btn');
            }
        }

        // Subscriber management
        async function deletePushSubscriber(id) {
            if (!confirm('Are you sure you want to delete this push subscriber?')) return;
            
            try {
                const data = await apiCall(`/api/push-subscriber/${id}`, { method: 'DELETE' });
                showNotification('Push subscriber deleted successfully', 'success');
                loadPushSubscribers();
            } catch (error) {
                showNotification('Failed to delete push subscriber', 'error');
            }
        }

        async function resendWelcomeEmail(email, location) {
            if (!confirm(`Resend welcome email to ${email}?`)) return;
            
            try {
                const data = await apiCall('/admin/resend-welcome', {
                    method: 'POST',
                    body: JSON.stringify({ email, location })
                });
                
                showNotification('Welcome email resent successfully', 'success');
            } catch (error) {
                showNotification('Failed to resend welcome email', 'error');
            }
        }

        async function deleteSubscriber(email) {
            if (!confirm(`Delete subscriber ${email}? This cannot be undone.`)) return;
            
            try {
                const data = await apiCall('/admin/delete-subscriber', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });
                
                showNotification('Subscriber deleted successfully', 'success');
                location.reload();
            } catch (error) {
                showNotification('Failed to delete subscriber', 'error');
            }
        }

        // App update management
        async function checkForUpdates() {
            showLoading('check-updates');
            
            try {
                const data = await apiCall('/api/updates/check', { method: 'POST' });
                showNotification('Update check completed', 'success');
            } catch (error) {
                showNotification('Failed to check for updates', 'error');
            } finally {
                hideLoading('check-updates');
            }
        }

        async function publishUpdate() {
            const updateType = document.getElementById('update-type').value;
            const updateChannel = document.getElementById('update-channel').value;
            
            showLoading('publish-update');
            
            try {
                const data = await apiCall('/api/updates/publish', {
                    method: 'POST',
                    body: JSON.stringify({
                        update_type: updateType,
                        channel: updateChannel
                    })
                });
                
                showNotification('Update published successfully', 'success');
            } catch (error) {
                showNotification('Failed to publish update', 'error');
            } finally {
                hideLoading('publish-update');
            }
        }

        async function rollbackUpdate() {
            if (!confirm('Are you sure you want to rollback the current update? This will revert to the previous version.')) return;
            
            showLoading('rollback-update');
            
            try {
                const data = await apiCall('/api/updates/rollback', { method: 'POST' });
                showNotification('Update rollback completed', 'success');
            } catch (error) {
                showNotification('Failed to rollback update', 'error');
            } finally {
                hideLoading('rollback-update');
            }
        }

        // Utility functions
        function refreshAllData() {
            loadStats();
            loadSchedulerHealth();
            loadLogs();
            loadPushSubscribers();
            showNotification('Data refreshed', 'info');
        }
    </script>
</body>
</html> 